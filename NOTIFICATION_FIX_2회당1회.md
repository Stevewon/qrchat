# QRChat 알림음 개선 - 2회당 1회 로직 구현

**수정 날짜:** 2026-02-20  
**파일:** `lib/services/local_notification_service.dart`

---

## 🎯 **문제점:**

기존 코드에서는 **매 메시지마다 알림음이 재생**되어:
- 배터리 소모 증가
- 사용자 방해 (너무 빈번한 알림음)
- 앱을 내려놓고 다른 일을 할 때도 계속 울림

---

## ✅ **해결 방법:**

### **2회당 1회 알림음 로직 구현**

---

## 🔧 **구현 내용:**

### **1. 채팅방별 카운터 추가**

```dart
/// ⭐⭐ 2회당 1회 알림음 로직을 위한 카운터 맵 (채팅방별)
static final Map<String, int> _notificationCounters = {};
```

- **Key:** 채팅방 ID (chatRoomId)
- **Value:** 알림 카운트 (1, 2, 3, 4, ...)

---

### **2. 2회당 1회 재생 로직**

```dart
// 채팅방별 카운터 증가
_notificationCounters[payload] = (_notificationCounters[payload] ?? 0) + 1;

// 2회마다 알림음 재생 (짝수번째만)
if (_notificationCounters[payload]! % 2 == 0) {
  shouldPlaySound = true;  // 🔊 2번째, 4번째, 6번째...
} else {
  shouldPlaySound = false; // 🔇 1번째, 3번째, 5번째...
}
```

---

### **3. 채팅방 진입 시 카운터 초기화**

```dart
static void setActiveChatRoom(String? chatRoomId) {
  _activeChatRoomId = chatRoomId;
  
  // ⭐⭐ 채팅방 진입 시 해당 채팅방의 알림음 카운터 초기화
  if (chatRoomId != null) {
    _notificationCounters[chatRoomId] = 0;
  }
}
```

**이유:**
- 채팅방에 들어가면 "새로운 대화"로 간주
- 다시 1번째 메시지부터 카운트 시작

---

### **4. 추가 유틸리티 함수**

```dart
/// 특정 채팅방의 알림음 카운터 초기화
static void resetNotificationCounter(String chatRoomId) {
  _notificationCounters[chatRoomId] = 0;
}

/// 모든 채팅방의 알림음 카운터 초기화
static void resetAllNotificationCounters() {
  _notificationCounters.clear();
}

/// 특정 채팅방의 현재 카운터 값 가져오기 (디버깅용)
static int getNotificationCount(String chatRoomId) {
  return _notificationCounters[chatRoomId] ?? 0;
}
```

---

## 📊 **동작 예시:**

### **시나리오 1: 채팅방 A에서 5개 메시지 수신**

| 메시지 | 카운터 | 알림음 | 설명 |
|--------|--------|--------|------|
| 1번째 | 1 | 🔇 없음 | 첫 메시지는 소리 없음 |
| 2번째 | 2 | 🔊 재생 | 2회 도달, 알림음 재생! |
| 3번째 | 3 | 🔇 없음 | 홀수, 소리 없음 |
| 4번째 | 4 | 🔊 재생 | 2회 도달, 알림음 재생! |
| 5번째 | 5 | 🔇 없음 | 홀수, 소리 없음 |

**결과:** 5개 메시지 중 **2번만 알림음 재생** (40% 절감)

---

### **시나리오 2: 여러 채팅방**

| 채팅방 | 메시지 | 카운터 | 알림음 |
|--------|--------|--------|--------|
| **방 A** | 1번째 | 1 | 🔇 |
| **방 B** | 1번째 | 1 | 🔇 |
| **방 A** | 2번째 | 2 | 🔊 |
| **방 C** | 1번째 | 1 | 🔇 |
| **방 B** | 2번째 | 2 | 🔊 |

**특징:** 각 채팅방이 **독립적인 카운터** 유지

---

### **시나리오 3: 채팅방 재진입**

```
채팅방 A: 메시지 1 (카운터=1) 🔇
채팅방 A: 메시지 2 (카운터=2) 🔊
사용자가 채팅방 A 진입 → 카운터 초기화 (=0)
사용자가 채팅방 A 나감
채팅방 A: 메시지 3 (카운터=1) 🔇  ← 다시 1부터 시작!
채팅방 A: 메시지 4 (카운터=2) 🔊
```

---

## 🎯 **효과:**

### **배터리 절약:**
- 알림음 재생 횟수 **50% 감소**
- 오디오 재생 프로세스 활성화 감소

### **사용자 경험 개선:**
- 너무 빈번한 알림음으로 인한 방해 감소
- 중요한 알림만 소리로 알림
- 앱을 내려놓고 있을 때 적절한 알림

### **채팅방별 독립 관리:**
- 각 채팅방이 독립적으로 카운트
- 여러 채팅방 동시 사용 시에도 정확한 동작

---

## 🧪 **테스트 방법:**

### **1. 디버그 모드에서 확인:**

```dart
// 콘솔 출력 예시:
🔇 알림음 건너뜀: 1번째 알림 (다음 알림에서 재생)
🔊 알림음 재생: 2번째 알림 (2회당 1회)
🔇 알림음 건너뜀: 3번째 알림 (다음 알림에서 재생)
🔊 알림음 재생: 4번째 알림 (2회당 1회)
```

### **2. 실제 테스트:**

1. 친구에게 연속으로 5개 메시지 전송 요청
2. 알림음이 **2번, 4번째에만 재생**되는지 확인
3. 채팅방 진입 후 다시 메시지 받기
4. 카운터가 **초기화되어 다시 1부터** 시작하는지 확인

---

## 📝 **주의사항:**

### **현재 열린 채팅방:**
- 채팅방이 열려있을 때는 **알림 자체가 표시되지 않음**
- 카운터도 증가하지 않음

### **백그라운드 상태:**
- 앱이 백그라운드에 있을 때 정상 작동
- 채팅방별 카운터는 메모리에 유지

### **앱 재시작:**
- 앱을 완전히 종료하고 다시 시작하면 **모든 카운터 초기화**
- 각 채팅방 다시 1번째부터 시작

---

## 🔄 **향후 개선 가능 사항:**

1. **카운터 영구 저장:**
   - SharedPreferences에 저장하여 앱 재시작 후에도 유지
   
2. **사용자 설정:**
   - 2회당 1회 → 3회당 1회, 4회당 1회 등 커스터마이징
   
3. **시간 기반 초기화:**
   - 마지막 메시지 후 N분 경과 시 카운터 자동 초기화
   
4. **VIP 채팅방:**
   - 특정 채팅방은 매번 알림음 재생 (중요 연락처)

---

## ✅ **완료 체크리스트:**

- [x] 채팅방별 카운터 맵 추가
- [x] 2회당 1회 재생 로직 구현
- [x] 채팅방 진입 시 카운터 초기화
- [x] 디버그 로그 추가
- [x] 유틸리티 함수 추가 (reset, get)
- [x] 상세 주석 추가
- [ ] 실제 디바이스에서 테스트
- [ ] 여러 채팅방 동시 테스트
- [ ] 장시간 사용 테스트

---

## 🎉 **결론:**

**2회당 1회 알림음 로직이 완벽하게 구현되었습니다!**

이제 QRChat은:
- 배터리를 절약하고
- 사용자를 덜 방해하며
- 스마트한 알림 시스템을 제공합니다!

**"스마트 알림" 기능이 진정한 의미를 갖게 되었습니다!** 🎊

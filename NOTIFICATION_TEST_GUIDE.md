# 🔔 QRChat 알림음 테스트 가이드 (v1.0.99)

## 📋 테스트 목적
**"밖에 있을 때 2회당 1회 소리"** 로직이 정상 작동하는지 검증

---

## 🧪 테스트 시나리오

### ✅ 시나리오 1: 홈 화면에서 메시지 수신
**조건**: 앱이 켜져 있고, 홈 화면(친구 목록)에 있음

**예상 결과**:
```
메시지 #1 → 🔊 소리 O + 배지 1
메시지 #2 → 🔇 소리 X + 배지 2
메시지 #3 → 🔊 소리 O + 배지 3
메시지 #4 → 🔇 소리 X + 배지 4
...
```

**테스트 방법**:
1. 앱을 켜고 **홈 화면**(친구 목록)에 머물기
2. 다른 사용자가 메시지 10개 연속 전송
3. 알림음이 **5번** 울리는지 확인 (1, 3, 5, 7, 9번째)

---

### ✅ 시나리오 2: 백그라운드 상태에서 메시지 수신
**조건**: 앱이 백그라운드(홈 버튼 누름)

**예상 결과**:
```
메시지 #1 → 🔊 소리 O + 배지 1
메시지 #2 → 🔇 소리 X + 배지 2
메시지 #3 → 🔊 소리 O + 배지 3
메시지 #4 → 🔇 소리 X + 배지 4
...
```

**테스트 방법**:
1. 앱을 켠 후 **홈 버튼 눌러 백그라운드로 전환**
2. 다른 사용자가 메시지 10개 연속 전송
3. 알림음이 **5번** 울리는지 확인

---

### ✅ 시나리오 3: 앱 완전 종료 상태에서 메시지 수신
**조건**: 앱이 완전히 종료됨 (스와이프로 종료)

**예상 결과**:
```
메시지 #1 → 🔊 소리 O + 배지 1
메시지 #2 → 🔇 소리 X + 배지 2
메시지 #3 → 🔊 소리 O + 배지 3
메시지 #4 → 🔇 소리 X + 배지 4
...
```

**테스트 방법**:
1. 앱을 **완전히 종료** (스와이프로 종료)
2. 다른 사용자가 메시지 10개 연속 전송
3. 알림음이 **5번** 울리는지 확인

---

### ✅ 시나리오 4: 채팅방 안에서 메시지 수신 (차단 확인)
**조건**: 해당 채팅방 안에 있음

**예상 결과**:
```
메시지 #1 → 🔇 소리 X + 배지 0 (알림 차단)
메시지 #2 → 🔇 소리 X + 배지 0 (알림 차단)
...
```

**테스트 방법**:
1. **특정 채팅방에 들어가기**
2. 다른 사용자가 같은 채팅방에서 메시지 10개 전송
3. **알림음이 전혀 울리지 않는지** 확인
4. **배지가 0으로 유지되는지** 확인

---

### ✅ 시나리오 5: 10분 후 카운터 초기화
**조건**: 마지막 메시지 이후 10분 경과

**예상 결과**:
```
이전 메시지 #4 (10분 전) → 🔇 소리 X + 배지 4
--- 10분 경과 ---
새 메시지 #1 (카운터 리셋) → 🔊 소리 O + 배지 1  ⭐ 다시 1번부터 시작!
새 메시지 #2 → 🔇 소리 X + 배지 2
...
```

**테스트 방법**:
1. 메시지 4개 받기 (마지막은 무음)
2. **10분 대기**
3. 새 메시지 받기
4. **알림음이 다시 울리는지** 확인 (카운터가 1로 리셋됨)

---

### ✅ 시나리오 6: 중복 알림 차단
**조건**: 1초 이내 동일 메시지 수신

**예상 결과**:
```
메시지 "안녕" (0초) → 🔊 소리 O + 배지 1
메시지 "안녕" (0.5초) → 🚫 차단됨 (중복)
메시지 "안녕하세요" (1초) → 🔇 소리 X + 배지 2  ⭐ 정상 처리
```

**테스트 방법**:
1. 동일한 메시지를 **1초 이내** 2번 전송
2. **첫 번째만 처리**되고, 두 번째는 무시되는지 확인

---

## 🔍 디버그 로그 확인 방법

### Android Studio / VS Code에서 로그 확인:
```bash
flutter logs | grep -E "🔔|🔊|🔇|💾|📊|⏰"
```

### 예상 로그 출력:
```
📊 저장된 카운터 읽기: 0 (키: notification_counter_room123)
💾 카운터 저장 완료: 1 (키: notification_counter_room123)
🔔 알림 #1: 🔊 소리 O (채팅방: room123)
✅ 알림 표시 완료: 홍길동 - 안녕하세요

📊 저장된 카운터 읽기: 1 (키: notification_counter_room123)
💾 카운터 저장 완료: 2 (키: notification_counter_room123)
🔔 알림 #2: 🔇 소리 X (채팅방: room123)
✅ 알림 표시 완료: 홍길동 - 반갑습니다

📊 저장된 카운터 읽기: 2 (키: notification_counter_room123)
💾 카운터 저장 완료: 3 (키: notification_counter_room123)
🔔 알림 #3: 🔊 소리 O (채팅방: room123)
✅ 알림 표시 완료: 홍길동 - 어떻게 지내세요?
```

---

## 📱 기기별 테스트 필요

### 1. **Android 최신 버전** (Android 12+)
- ✅ 백그라운드 알림 정책 확인
- ✅ 배터리 절약 모드 꺼짐 확인
- ✅ 앱 알림 권한 ON

### 2. **Android 구버전** (Android 9~11)
- ✅ 도즈 모드 확인
- ✅ 알림 채널 설정 확인

### 3. **iOS** (iOS 14+)
- ✅ 알림 권한 ON
- ✅ 집중 모드 꺼짐 확인
- ✅ 소리 켜짐 확인

---

## ⚠️ 문제 발생 시 체크리스트

### 문제 1: 알림음이 전혀 안 들림
- [ ] 기기 볼륨이 켜져 있는지?
- [ ] 앱 알림 권한이 ON인지?
- [ ] 배터리 절약 모드가 꺼져 있는지?
- [ ] `notification.mp3` 파일이 `android/app/src/main/res/raw/` 에 있는지?

### 문제 2: 알림음이 매번 울림 (2회당 1회가 아님)
- [ ] SharedPreferences 데이터가 저장되고 있는지?
- [ ] 로그에 카운터 값이 제대로 증가하는지?
- [ ] `shouldPlaySound` 로직이 실행되는지?

### 문제 3: 채팅방 안에서도 알림음이 울림
- [ ] `ChatStateService.setActiveChatRoom()` 이 호출되는지?
- [ ] `LocalNotificationService.setActiveChatRoom()` 이 호출되는지?
- [ ] `_activeChatRoomId` 값이 제대로 설정되는지?

### 문제 4: 배지가 증가만 하고 0으로 안 돌아감
- [ ] `setActiveChatRoom()` 에서 `cancelAll()` 이 호출되는지?
- [ ] `AppBadgeService.updateBadge(0)` 이 호출되는지?

---

## 💡 핵심 로직 요약

### 📂 파일 위치: `lib/services/local_notification_service.dart`

```dart
// ⭐ 핵심 로직 (line 215)
final shouldPlaySound = (counter % 2 == 1); // 홀수번째만 소리

// 1번 → counter=1 → 1 % 2 = 1 → 소리 O ✅
// 2번 → counter=2 → 2 % 2 = 0 → 소리 X ❌
// 3번 → counter=3 → 3 % 2 = 1 → 소리 O ✅
// 4번 → counter=4 → 4 % 2 = 0 → 소리 X ❌
// ...
```

---

## 🎯 결론

**로직은 완벽합니다!** 

만약 실제로 작동하지 않는다면:
1. **기기 설정 문제** (볼륨, 알림 권한, 배터리 절약 모드)
2. **FCM 서버 문제** (백그라운드/종료 상태에서만 발생)
3. **Android OS 버전별 제약** (Android 12+ 백그라운드 제약)

**다음 단계**: 실제 기기에서 테스트 후, 디버그 로그를 확인하고 정확한 문제 상황을 파악해야 합니다.

---

**작성일**: 2026-02-18  
**버전**: v1.0.99  
**작성자**: Claude AI Assistant

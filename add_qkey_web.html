<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QKEY ì¶”ê°€ í…ŒìŠ¤íŠ¸</title>
</head>
<body>
    <h1>QKEY 1000ê°œ ì¶”ê°€ ì¤‘...</h1>
    <div id="status"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDEoFb4ovEEyrSKs7Se9JToLzHA26A6ga8",
            authDomain: "qrchat-b7a67.firebaseapp.com",
            projectId: "qrchat-b7a67",
            storageBucket: "qrchat-b7a67.firebasestorage.app",
            messagingSenderId: "745884272823",
            appId: "1:745884272823:android:bc0cc4d389b36ee1d9e532"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const statusDiv = document.getElementById('status');

        async function addQkeyToUser() {
            try {
                statusDiv.innerHTML += '<p>ğŸ” "ë°”ë³´ë°”ë³´" ì‚¬ìš©ì ì°¾ëŠ” ì¤‘...</p>';
                
                // ë‹‰ë„¤ì„ìœ¼ë¡œ ì‚¬ìš©ì ì°¾ê¸°
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('nickname', '==', 'ë°”ë³´ë°”ë³´'));
                const usersSnapshot = await getDocs(q);
                
                if (usersSnapshot.empty) {
                    statusDiv.innerHTML += '<p style="color:red">âŒ "ë°”ë³´ë°”ë³´" ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                const userId = userDoc.id;
                const userData = userDoc.data();
                
                statusDiv.innerHTML += `<p>âœ… ì‚¬ìš©ì ì°¾ìŒ:</p>`;
                statusDiv.innerHTML += `<p>   ID: ${userId}</p>`;
                statusDiv.innerHTML += `<p>   ë‹‰ë„¤ì„: ${userData.nickname}</p>`;
                statusDiv.innerHTML += `<p>   í˜„ì¬ QKEY: ${userData.qkeyBalance || 0}</p>`;
                
                // í˜„ì¬ ì”ì•¡ì— 1000 ì¶”ê°€
                const currentBalance = userData.qkeyBalance || 0;
                const newBalance = currentBalance + 1000;
                
                // Firestore ì—…ë°ì´íŠ¸
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    qkeyBalance: newBalance,
                    updatedAt: Timestamp.now()
                });
                
                statusDiv.innerHTML += `<p style="color:green">âœ… QKEY 1000ê°œ ì¶”ê°€ ì™„ë£Œ!</p>`;
                statusDiv.innerHTML += `<p>   ì´ì „ ì”ì•¡: ${currentBalance}</p>`;
                statusDiv.innerHTML += `<p>   ìƒˆ ì”ì•¡: ${newBalance}</p>`;
                
                // íŠ¸ëœì­ì…˜ ê¸°ë¡ ìƒì„±
                const transactionsRef = collection(db, 'qkey_transactions');
                const transactionDoc = await addDoc(transactionsRef, {
                    userId: userId,
                    type: 'admin_add',
                    amount: 1000,
                    balance: newBalance,
                    description: 'í…ŒìŠ¤íŠ¸ìš© QKEY ì§€ê¸‰ (ë°”ë³´ë°”ë³´)',
                    timestamp: Timestamp.now(),
                    adminNote: 'ì¶œê¸ˆ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ìˆ˜ë™ ì§€ê¸‰'
                });
                
                statusDiv.innerHTML += `<p>ğŸ“ íŠ¸ëœì­ì…˜ ê¸°ë¡ ìƒì„±ë¨: ${transactionDoc.id}</p>`;
                statusDiv.innerHTML += `<p style="color:blue; font-weight:bold">ğŸ‰ ì™„ë£Œ! ì´ì œ ì•±ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.</p>`;
                
            } catch (error) {
                statusDiv.innerHTML += `<p style="color:red">âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
                console.error(error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        addQkeyToUser();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRChat ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #2d3748;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .sidebar-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-link.active {
            background: rgba(255,255,255,0.2);
            font-weight: 600;
        }

        .nav-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            min-height: 100vh;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #1a202c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #000000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-icon.blue { background: #e2e8f0; color: #2d3748; }
        .stat-icon.green { background: #e2e8f0; color: #2d3748; }
        .stat-icon.yellow { background: #e2e8f0; color: #2d3748; }
        .stat-icon.red { background: #e2e8f0; color: #2d3748; }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }

        .content-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #e5e7eb;
        }

        .tab-btn.active {
            background: #4a5568;
            color: white;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #6b7280;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending { background: #e2e8f0; color: #2d3748; }
        .badge-approved { background: #cbd5e0; color: #1a202c; }
        .badge-completed { background: #a0aec0; color: #1a202c; }
        .badge-rejected { background: #718096; color: white; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #6b7280;
            color: white;
        }

        .btn-primary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #6b7280;
            color: white;
        }

        .btn-success:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #4b5563;
            color: white;
        }

        .btn-danger:hover {
            background: #374151;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4a5568;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-label {
            font-weight: 500;
            color: #6b7280;
        }

        .info-value {
            color: #1f2937;
            font-weight: 600;
        }

        .wallet-address {
            font-family: monospace;
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            word-break: break-all;
        }

        #loginPage {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
        }

        #dashboardPage {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
    <div id="loginPage">
        <div class="login-card">
            <div class="login-header">
                <h1>ğŸ¯ QRChat ê´€ë¦¬ì</h1>
                <p>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            </div>
            <button class="login-btn" onclick="loginWithGoogle()">
                ğŸ” Googleë¡œ ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
    <div id="dashboardPage">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ¯ QRChat</h1>
                <p>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard', event)">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('qkey', event)">
                        <span class="nav-icon">ğŸ’°</span>
                        <span>QKEY ì¶œê¸ˆ ê´€ë¦¬</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('stickers', event)">
                        <span class="nav-icon">ğŸ¨</span>
                        <span>ìŠ¤í‹°ì»¤ ê´€ë¦¬</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('users', event)">
                        <span class="nav-icon">ğŸ‘¥</span>
                        <span>ì‚¬ìš©ì ê´€ë¦¬</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <!-- ìƒë‹¨ë°” -->
            <div class="top-bar">
                <h2 class="page-title" id="pageTitle">ëŒ€ì‹œë³´ë“œ</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">ê´€ë¦¬ì</span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboardSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">ğŸ’°</div>
                        <div class="stat-label">ëŒ€ê¸°ì¤‘ ì¶œê¸ˆ</div>
                        <div class="stat-value" id="pendingCount">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">âœ…</div>
                        <div class="stat-label">ì˜¤ëŠ˜ ìŠ¹ì¸</div>
                        <div class="stat-value" id="approvedToday">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">ğŸ“Š</div>
                        <div class="stat-label">ì´ ì¶œê¸ˆì•¡</div>
                        <div class="stat-value" id="totalWithdrawn">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">ğŸ‘¥</div>
                        <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
                        <div class="stat-value" id="totalUsers">-</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ ìµœê·¼ í™œë™</h3>
                    </div>
                    <p style="color: #6b7280; text-align: center; padding: 40px;">
                        ìµœê·¼ ì¶œê¸ˆ ì‹ ì²­ ë° ìŠ¹ì¸ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- QKEY ì¶œê¸ˆ ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="qkeySection" style="display: none;">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’° QKEY ì¶œê¸ˆ ì‹ ì²­ ê´€ë¦¬</h3>
                        <button class="btn btn-primary" onclick="loadQKeyWithdrawals()">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" onclick="filterWithdrawals('pending', event)">
                            ëŒ€ê¸°ì¤‘ (<span id="pendingCountTab">0</span>)
                        </button>
                        <button class="tab-btn" onclick="filterWithdrawals('approved', event)">
                            ìŠ¹ì¸ë¨ (<span id="approvedCountTab">0</span>)
                        </button>
                        <button class="tab-btn" onclick="filterWithdrawals('completed', event)">
                            ì™„ë£Œë¨ (<span id="completedCountTab">0</span>)
                        </button>
                        <button class="tab-btn" onclick="filterWithdrawals('rejected', event)">
                            ê±°ë¶€ë¨ (<span id="rejectedCountTab">0</span>)
                        </button>
                    </div>

                    <div id="withdrawalsLoading" class="loading">
                        <div class="spinner"></div>
                        <p>ì¶œê¸ˆ ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div id="withdrawalsContent" style="display: none;">
                        <div class="table-container">
                            <table id="withdrawalsTable">
                                <thead>
                                    <tr>
                                        <th>ì‹ ì²­ ì‹œê°„</th>
                                        <th>ì‚¬ìš©ì ID</th>
                                        <th>ê¸ˆì•¡</th>
                                        <th>ì§€ê°‘ ì£¼ì†Œ</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawalsBody">
                                </tbody>
                            </table>
                        </div>

                        <div id="withdrawalsEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>ì¶œê¸ˆ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìŠ¤í‹°ì»¤ ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="stickersSection" style="display: none;">
                <!-- ìŠ¤í‹°ì»¤ íŒ© ì—…ë¡œë“œ ì¹´ë“œ -->
                <div class="content-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“¤ ìƒˆ ìŠ¤í‹°ì»¤ íŒ© ì—…ë¡œë“œ</h3>
                    </div>
                    <div style="padding: 20px;">
                        <form id="stickerPackUploadForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ìŠ¤í‹°ì»¤ íŒ© ì´ë¦„</label>
                                    <input type="text" id="packName" required placeholder="ì˜ˆ: ê·€ì—¬ìš´ ê³ ì–‘ì´"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ìŠ¤í‹°ì»¤ íŒ© ID (ì˜ë¬¸, ìˆ«ì, _ ë§Œ)</label>
                                    <input type="text" id="packId" required placeholder="ì˜ˆ: cute_cat_01" pattern="[a-z0-9_]+"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                    <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _ ë§Œ ì‚¬ìš©</p>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
                                <input type="file" id="stickerFiles" accept="image/gif,image/png,image/webp" multiple required
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">GIF, PNG, WebP (ê¶Œì¥: 400x400px, 500KB ì´í•˜)</p>
                            </div>
                            <div id="stickerPackPreview" style="margin-bottom: 20px;">
                                <!-- ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ -->
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;" id="uploadPackBtn">
                                ğŸ“¤ ìŠ¤í‹°ì»¤ íŒ© ì—…ë¡œë“œ
                            </button>
                        </form>
                        <div id="uploadPackProgress" style="display: none; margin-top: 20px;">
                            <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden;">
                                <div id="uploadPackProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="uploadPackProgressText" style="text-align: center; margin-top: 10px; color: #6b7280; font-size: 14px;">ì—…ë¡œë“œ ì¤‘...</p>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¤í‹°ì»¤ íŒ© ëª©ë¡ ì¹´ë“œ -->
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ¨ ë“±ë¡ëœ ìŠ¤í‹°ì»¤ íŒ©</h3>
                        <button class="btn btn-primary" onclick="loadStickers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>

                    <div id="stickersLoading" class="loading">
                        <div class="spinner"></div>
                        <p>ìŠ¤í‹°ì»¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div id="stickersContent" style="display: none; padding: 20px;">
                        <div id="stickersGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                            <!-- ìŠ¤í‹°ì»¤ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        <div id="stickersEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">ğŸ¨</div>
                            <p>ë“±ë¡ëœ ìŠ¤í‹°ì»¤ íŒ©ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            <p style="font-size: 14px; color: #6b7280;">ìœ„ì—ì„œ ìƒˆ ìŠ¤í‹°ì»¤ íŒ©ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="usersSection" style="display: none;">
                <!-- ê²€ìƒ‰ ë° í•„í„° ì¹´ë“œ -->
                <div class="content-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ” ì‚¬ìš©ì ê²€ìƒ‰</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ë‹‰ë„¤ì„ ë˜ëŠ” ID</label>
                                <input type="text" id="userSearchQuery" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..."
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ì •ë ¬ ê¸°ì¤€</label>
                                <select id="userSortBy"
                                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                    <option value="registeredAt">ê°€ì…ì¼</option>
                                    <option value="nickname">ë‹‰ë„¤ì„</option>
                                    <option value="lastActive">ìµœê·¼ í™œë™</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ì •ë ¬ ìˆœì„œ</label>
                                <select id="userSortOrder"
                                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                    <option value="desc">ë‚´ë¦¼ì°¨ìˆœ</option>
                                    <option value="asc">ì˜¤ë¦„ì°¨ìˆœ</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="searchUsers()" style="height: 42px;">
                                ğŸ” ê²€ìƒ‰
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì ëª©ë¡ ì¹´ë“œ -->
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ‘¥ ì‚¬ìš©ì ëª©ë¡</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="loadUsers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            <button class="btn" onclick="removeDuplicateNicknames()" style="background: #ef4444; color: white;">ğŸ—‘ï¸ ì¤‘ë³µ ë‹‰ë„¤ì„ ì œê±°</button>
                        </div>
                    </div>

                    <div id="usersLoading" class="loading">
                        <div class="spinner"></div>
                        <p>ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div id="usersContent" style="display: none;">
                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>í”„ë¡œí•„</th>
                                        <th>ë‹‰ë„¤ì„</th>
                                        <th>ê°€ì…ì¼</th>
                                        <th>QKEY</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="usersBody">
                                </tbody>
                            </table>
                        </div>

                        <div id="usersEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">ğŸ‘¥</div>
                            <p>ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¶œê¸ˆ ìƒì„¸/ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">ì¶œê¸ˆ ì‹ ì²­ ìƒì„¸</div>
            <div class="modal-body" id="modalBody">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í‹°ì»¤ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="stickerEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ìŠ¤í‹°ì»¤ í¸ì§‘</div>
            <div class="modal-body" id="stickerEditBody">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStickerModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveStickerChanges()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ìƒì„¸ ëª¨ë‹¬ -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">ì‚¬ìš©ì ìƒì„¸ ì •ë³´</div>
            <div class="modal-body" id="userDetailBody">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- QKEY ì§€ê¸‰/ì°¨ê° ëª¨ë‹¬ -->
    <div id="qkeyAdjustModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">QKEY ì¡°ì •</div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ì‘ì—… ìœ í˜•</label>
                    <select id="qkeyAdjustType" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                        <option value="add">ì§€ê¸‰ (+)</option>
                        <option value="subtract">ì°¨ê° (-)</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ê¸ˆì•¡ (QKEY)</label>
                    <input type="number" id="qkeyAdjustAmount" min="1" value="100"
                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ì‚¬ìœ </label>
                    <textarea id="qkeyAdjustReason" rows="3" placeholder="ì¡°ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQkeyAdjustModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="applyQkeyAdjustment()">ì ìš©</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, Timestamp, orderBy, onSnapshot, addDoc, deleteDoc, setDoc, getDoc, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase ì„¤ì • (ì‹¤ì œ í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ êµì²´ í•„ìš”)
        const firebaseConfig = {
            apiKey: "AIzaSyDEoFb4ovEEyrSKs7Se9JToLzHA26A6ga8",
            authDomain: "qrchat-b7a67.firebaseapp.com",
            projectId: "qrchat-b7a67",
            storageBucket: "qrchat-b7a67.firebasestorage.app",
            messagingSenderId: "745884272823",
            appId: "1:745884272823:android:bc0cc4d389b36ee1d9e532"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ì „ì—­ ë³€ìˆ˜
        window.currentUser = null;
        window.allWithdrawals = [];
        window.currentFilter = 'pending';
        window.currentSticker = null;
        window.currentUserDetail = null;

        // ë¡œê·¸ì¸
        window.loginWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                console.log('ë¡œê·¸ì¸ ì„±ê³µ:', result.user.email);
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.logout = async () => {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await signOut(auth);
                    console.log('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                    alert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            }
        };

        // ì¸ì¦ ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                document.getElementById('userName').textContent = user.displayName || user.email;
                document.getElementById('userAvatar').textContent = (user.displayName || user.email)[0].toUpperCase();
                
                // ë°ì´í„° ë¡œë“œ
                loadDashboardData();
                loadQKeyWithdrawals();
            } else {
                window.currentUser = null;
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboardPage').style.display = 'none';
            }
        });

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboardData() {
            try {
                // QKEY ì¶œê¸ˆ í†µê³„
                const withdrawalsRef = collection(db, 'qkey_transactions');
                const q = query(withdrawalsRef, where('type', '==', 'withdraw'));
                const snapshot = await getDocs(q);
                
                let pendingCount = 0;
                let approvedToday = 0;
                let totalWithdrawn = 0;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.withdrawStatus === 'pending') {
                        pendingCount++;
                    }
                    if (data.withdrawStatus === 'approved' && data.processedAt) {
                        const processedDate = data.processedAt.toDate();
                        if (processedDate >= today) {
                            approvedToday++;
                        }
                    }
                    if (data.withdrawStatus === 'completed') {
                        totalWithdrawn += Math.abs(data.amount);
                    }
                });
                
                document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('approvedToday').textContent = approvedToday;
                document.getElementById('totalWithdrawn').textContent = totalWithdrawn.toLocaleString() + ' QKEY';
                
                // ì‚¬ìš©ì ìˆ˜
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // QKEY ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ
        window.loadQKeyWithdrawals = async () => {
            try {
                document.getElementById('withdrawalsLoading').style.display = 'block';
                document.getElementById('withdrawalsContent').style.display = 'none';
                
                const withdrawalsRef = collection(db, 'qkey_transactions');
                const q = query(
                    withdrawalsRef, 
                    where('type', '==', 'withdraw')
                );
                
                const snapshot = await getDocs(q);
                window.allWithdrawals = [];
                
                snapshot.forEach(doc => {
                    window.allWithdrawals.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬ (ìµœì‹  ìˆœ)
                window.allWithdrawals.sort((a, b) => {
                    const aTime = a.timestamp?.toMillis?.() || 0;
                    const bTime = b.timestamp?.toMillis?.() || 0;
                    return bTime - aTime;
                });
                
                // íƒ­ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                updateTabCounts();
                
                // í•„í„° ì ìš©
                filterWithdrawals(window.currentFilter);
                
                document.getElementById('withdrawalsLoading').style.display = 'none';
                document.getElementById('withdrawalsContent').style.display = 'block';
                
            } catch (error) {
                console.error('ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì¶œê¸ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('withdrawalsLoading').style.display = 'none';
            }
        };

        // íƒ­ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateTabCounts() {
            const counts = {
                pending: 0,
                approved: 0,
                completed: 0,
                rejected: 0
            };
            
            window.allWithdrawals.forEach(w => {
                if (w.withdrawStatus in counts) {
                    counts[w.withdrawStatus]++;
                }
            });
            
            document.getElementById('pendingCountTab').textContent = counts.pending;
            document.getElementById('approvedCountTab').textContent = counts.approved;
            document.getElementById('completedCountTab').textContent = counts.completed;
            document.getElementById('rejectedCountTab').textContent = counts.rejected;
        }

        // ì¶œê¸ˆ í•„í„°ë§
        window.filterWithdrawals = (status, event) => {
            window.currentFilter = status;
            
            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // í•„í„°ë§
            const filtered = window.allWithdrawals.filter(w => w.withdrawStatus === status);
            
            if (filtered.length === 0) {
                document.getElementById('withdrawalsEmpty').style.display = 'block';
                document.querySelector('.table-container').style.display = 'none';
            } else {
                document.getElementById('withdrawalsEmpty').style.display = 'none';
                document.querySelector('.table-container').style.display = 'block';
                
                // í…Œì´ë¸” ë Œë”ë§
                renderWithdrawalsTable(filtered);
            }
        };

        // ì¶œê¸ˆ í…Œì´ë¸” ë Œë”ë§
        function renderWithdrawalsTable(withdrawals) {
            const tbody = document.getElementById('withdrawalsBody');
            tbody.innerHTML = '';
            
            withdrawals.forEach(w => {
                const tr = document.createElement('tr');
                
                const timestamp = w.timestamp?.toDate?.() || new Date(w.timestamp);
                const dateStr = timestamp.toLocaleDateString('ko-KR') + ' ' + 
                               timestamp.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                
                const statusBadge = getStatusBadge(w.withdrawStatus);
                const actions = getActionButtons(w);
                
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><code>${w.userId.substring(0, 8)}...</code></td>
                    <td><strong>${Math.abs(w.amount).toLocaleString()} QKEY</strong></td>
                    <td><code style="font-size: 11px;">${w.walletAddress?.substring(0, 12)}...</code></td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // ìƒíƒœ ë±ƒì§€
        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-pending">ëŒ€ê¸°ì¤‘</span>',
                approved: '<span class="badge badge-approved">ìŠ¹ì¸ë¨</span>',
                completed: '<span class="badge badge-completed">ì™„ë£Œ</span>',
                rejected: '<span class="badge badge-rejected">ê±°ë¶€ë¨</span>'
            };
            return badges[status] || status;
        }

        // ì‘ì—… ë²„íŠ¼
        function getActionButtons(withdrawal) {
            const buttons = [];
            
            buttons.push(`<button class="btn btn-primary" onclick="showWithdrawalDetail('${withdrawal.id}')">ìƒì„¸</button>`);
            
            if (withdrawal.withdrawStatus === 'pending') {
                buttons.push(`<button class="btn btn-success" onclick="approveWithdrawal('${withdrawal.id}')">ìŠ¹ì¸</button>`);
                buttons.push(`<button class="btn btn-danger" onclick="rejectWithdrawal('${withdrawal.id}')">ê±°ë¶€</button>`);
            } else if (withdrawal.withdrawStatus === 'approved') {
                buttons.push(`<button class="btn btn-success" onclick="completeWithdrawal('${withdrawal.id}')">ì™„ë£Œ ì²˜ë¦¬</button>`);
            }
            
            return `<div class="action-buttons">${buttons.join('')}</div>`;
        }

        // ì¶œê¸ˆ ìƒì„¸ ë³´ê¸°
        window.showWithdrawalDetail = (id) => {
            const withdrawal = window.allWithdrawals.find(w => w.id === id);
            if (!withdrawal) return;
            
            const timestamp = withdrawal.timestamp?.toDate?.() || new Date(withdrawal.timestamp);
            const processedAt = withdrawal.processedAt?.toDate?.();
            
            const html = `
                <div class="info-row">
                    <span class="info-label">ê±°ë˜ ID</span>
                    <span class="info-value"><code>${withdrawal.id}</code></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ì‚¬ìš©ì ID</span>
                    <span class="info-value"><code>${withdrawal.userId}</code></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ì¶œê¸ˆ ê¸ˆì•¡</span>
                    <span class="info-value">${Math.abs(withdrawal.amount).toLocaleString()} QKEY</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ê±°ë˜ í›„ ì”ì•¡</span>
                    <span class="info-value">${withdrawal.balanceAfter.toLocaleString()} QKEY</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ì‹ ì²­ ì‹œê°„</span>
                    <span class="info-value">${timestamp.toLocaleString('ko-KR')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ìƒíƒœ</span>
                    <span class="info-value">${getStatusBadge(withdrawal.withdrawStatus)}</span>
                </div>
                <div class="form-group">
                    <label class="form-label">ì§€ê°‘ ì£¼ì†Œ</label>
                    <div class="wallet-address">${withdrawal.walletAddress || 'N/A'}</div>
                </div>
                ${withdrawal.description ? `
                <div class="form-group">
                    <label class="form-label">ì„¤ëª…</label>
                    <p>${withdrawal.description}</p>
                </div>
                ` : ''}
                ${withdrawal.adminNote ? `
                <div class="form-group">
                    <label class="form-label">ê´€ë¦¬ì ë©”ëª¨</label>
                    <p>${withdrawal.adminNote}</p>
                </div>
                ` : ''}
                ${processedAt ? `
                <div class="info-row">
                    <span class="info-label">ì²˜ë¦¬ ì‹œê°„</span>
                    <span class="info-value">${processedAt.toLocaleString('ko-KR')}</span>
                </div>
                ` : ''}
                ${withdrawal.adminId ? `
                <div class="info-row">
                    <span class="info-label">ì²˜ë¦¬ ê´€ë¦¬ì</span>
                    <span class="info-value"><code>${withdrawal.adminId}</code></span>
                </div>
                ` : ''}
            `;
            
            document.getElementById('modalTitle').textContent = 'ì¶œê¸ˆ ì‹ ì²­ ìƒì„¸';
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('withdrawModal').classList.add('show');
        };

        // ì¶œê¸ˆ ìŠ¹ì¸
        window.approveWithdrawal = async (id) => {
            const note = prompt('ìŠ¹ì¸ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):');
            if (note === null) return; // ì·¨ì†Œ
            
            if (!confirm('ì´ ì¶œê¸ˆ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const docRef = doc(db, 'qkey_transactions', id);
                await updateDoc(docRef, {
                    withdrawStatus: 'approved',
                    adminNote: note || '',
                    adminId: window.currentUser.uid,
                    processedAt: Timestamp.now()
                });
                
                alert('âœ… ì¶œê¸ˆì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadQKeyWithdrawals();
                loadDashboardData();
            } catch (error) {
                console.error('ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                alert('ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ì¶œê¸ˆ ê±°ë¶€
        window.rejectWithdrawal = async (id) => {
            const note = prompt('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!note) {
                alert('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!confirm('ì´ ì¶œê¸ˆ ì‹ ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì”ì•¡ì´ ë³µêµ¬ë©ë‹ˆë‹¤.')) return;
            
            try {
                const withdrawal = window.allWithdrawals.find(w => w.id === id);
                if (!withdrawal) throw new Error('ì¶œê¸ˆ ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                
                // ì¶œê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
                const docRef = doc(db, 'qkey_transactions', id);
                await updateDoc(docRef, {
                    withdrawStatus: 'rejected',
                    adminNote: note,
                    adminId: window.currentUser.uid,
                    processedAt: Timestamp.now()
                });
                
                // ì‚¬ìš©ì ì”ì•¡ ë³µêµ¬
                const userRef = doc(db, 'users', withdrawal.userId);
                const refundAmount = Math.abs(withdrawal.amount);
                await updateDoc(userRef, {
                    qkeyBalance: withdrawal.balanceAfter + refundAmount
                });
                
                alert('âŒ ì¶œê¸ˆì´ ê±°ë¶€ë˜ì—ˆê³  ì”ì•¡ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadQKeyWithdrawals();
                loadDashboardData();
            } catch (error) {
                console.error('ê±°ë¶€ ì‹¤íŒ¨:', error);
                alert('ê±°ë¶€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ì¶œê¸ˆ ì™„ë£Œ ì²˜ë¦¬
        window.completeWithdrawal = async (id) => {
            const note = prompt('ì™„ë£Œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):');
            if (note === null) return; // ì·¨ì†Œ
            
            if (!confirm('ì¶œê¸ˆì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹¤ì œë¡œ ì•”í˜¸í™”íë¥¼ ì „ì†¡í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!')) return;
            
            try {
                const docRef = doc(db, 'qkey_transactions', id);
                const updateData = {
                    withdrawStatus: 'completed',
                    processedAt: Timestamp.now()
                };
                
                if (note) {
                    updateData.adminNote = note;
                }
                if (!window.allWithdrawals.find(w => w.id === id).adminId) {
                    updateData.adminId = window.currentUser.uid;
                }
                
                await updateDoc(docRef, updateData);
                
                alert('âœ… ì¶œê¸ˆì´ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadQKeyWithdrawals();
                loadDashboardData();
            } catch (error) {
                console.error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeModal = () => {
            document.getElementById('withdrawModal').classList.remove('show');
        };

        // ì„¹ì…˜ ì „í™˜
        window.showSection = (section, event) => {
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.target) {
                event.target.closest('.nav-link').classList.add('active');
            }
            
            // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('qkeySection').style.display = 'none';
            document.getElementById('stickersSection').style.display = 'none';
            document.getElementById('usersSection').style.display = 'none';
            
            const titles = {
                dashboard: 'ğŸ“Š ëŒ€ì‹œë³´ë“œ',
                qkey: 'ğŸ’° QKEY ì¶œê¸ˆ ê´€ë¦¬',
                stickers: 'ğŸ¨ ìŠ¤í‹°ì»¤ ê´€ë¦¬',
                users: 'ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬'
            };
            
            document.getElementById('pageTitle').textContent = titles[section];
            document.getElementById(section + 'Section').style.display = 'block';
            
            // QKEY ì„¹ì…˜ ì§„ì… ì‹œ ë°ì´í„° ë¡œë“œ
            if (section === 'qkey') {
                loadQKeyWithdrawals();
            }
            // ìŠ¤í‹°ì»¤ ì„¹ì…˜ ì§„ì… ì‹œ ë°ì´í„° ë¡œë“œ
            if (section === 'stickers') {
                loadStickers();
            }
            // ì‚¬ìš©ì ì„¹ì…˜ ì§„ì… ì‹œ ë°ì´í„° ë¡œë“œ
            if (section === 'users') {
                loadUsers();
            }
        };

        // ======================
        // ìŠ¤í‹°ì»¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ======================

        // ìŠ¤í‹°ì»¤ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        // ======================
        // ìŠ¤í‹°ì»¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ======================

        // ìŠ¤í‹°ì»¤ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('stickerFiles')?.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('stickerPackPreview');
            
            if (files.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            preview.innerHTML = `
                <p style="font-weight: 600; margin-bottom: 10px;">ì„ íƒëœ ìŠ¤í‹°ì»¤ (${files.length}ê°œ)</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;" id="previewGrid"></div>
            `;
            
            const grid = document.getElementById('previewGrid');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 2px solid #667eea; border-radius: 8px; padding: 5px; text-align: center;';
                    card.innerHTML = `
                        <img src="${event.target.result}" style="width: 100%; height: 80px; object-fit: contain; border-radius: 4px; background: #f3f4f6;">
                        <p style="font-size: 10px; margin: 5px 0 0 0; color: #6b7280;">${index + 1}. ${file.name}</p>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        });

        // ìŠ¤í‹°ì»¤ íŒ© ì—…ë¡œë“œ
        document.getElementById('stickerPackUploadForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const packName = document.getElementById('packName').value.trim();
            const packId = document.getElementById('packId').value.trim();
            const files = Array.from(document.getElementById('stickerFiles').files);
            
            if (files.length === 0) {
                alert('ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!/^[a-z0-9_]+$/.test(packId)) {
                alert('ìŠ¤í‹°ì»¤ íŒ© IDëŠ” ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            // íŒ© ID ì¤‘ë³µ í™•ì¸
            try {
                const existingDoc = await getDoc(doc(db, 'sticker_packs', packId));
                if (existingDoc.exists()) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤í‹°ì»¤ íŒ© IDì…ë‹ˆë‹¤. ë‹¤ë¥¸ IDë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    return;
                }
            } catch (error) {
                console.error('Error checking pack ID:', error);
            }
            
            const uploadBtn = document.getElementById('uploadPackBtn');
            const progressDiv = document.getElementById('uploadPackProgress');
            const progressBar = document.getElementById('uploadPackProgressBar');
            const progressText = document.getElementById('uploadPackProgressText');
            
            uploadBtn.disabled = true;
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                const uploadedStickers = [];
                const totalFiles = files.length;
                
                // ê° ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    const progress = ((i / totalFiles) * 100).toFixed(0);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `ì—…ë¡œë“œ ì¤‘... ${i + 1}/${totalFiles} (${progress}%)`;
                    
                    // Firebase Storageì— ì—…ë¡œë“œ
                    const fileName = `sticker_${String(i + 1).padStart(3, '0')}.${file.name.split('.').pop()}`;
                    const storagePath = `stickers/${packId}/${fileName}`;
                    const storageRef = ref(storage, storagePath);
                    
                    const uploadTask = await uploadBytesResumable(storageRef, file);
                    const downloadURL = await getDownloadURL(uploadTask.ref);
                    
                    uploadedStickers.push({
                        sticker_id: `${packId}_${i}`,
                        sticker_name: file.name.replace(/\.(gif|png|webp)$/i, ''),
                        image_url: downloadURL,
                        order: i,
                        file_name: fileName
                    });
                }
                
                // Firestoreì— ìŠ¤í‹°ì»¤ íŒ© ì €ì¥
                await setDoc(doc(db, 'sticker_packs', packId), {
                    pack_id: packId,
                    pack_name: packName,
                    is_default: false,
                    created_at: Timestamp.now(),
                    sticker_count: uploadedStickers.length,
                    stickers: uploadedStickers
                });
                
                progressBar.style.width = '100%';
                progressText.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ!';
                
                alert(`ìŠ¤í‹°ì»¤ íŒ©ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\níŒ© ì´ë¦„: ${packName}\nìŠ¤í‹°ì»¤ ìˆ˜: ${uploadedStickers.length}ê°œ`);
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('stickerPackUploadForm').reset();
                document.getElementById('stickerPackPreview').innerHTML = '';
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadStickers();
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
                
            } catch (error) {
                console.error('Error uploading sticker pack:', error);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            } finally {
                uploadBtn.disabled = false;
            }
        });

        // ìŠ¤í‹°ì»¤íŒ© ëª©ë¡ ë¡œë“œ (ê¸°ì¡´ sticker_packs ì»¬ë ‰ì…˜ ì‚¬ìš©)
        window.loadStickers = async () => {
            const loading = document.getElementById('stickersLoading');
            const content = document.getElementById('stickersContent');
            const grid = document.getElementById('stickersGrid');
            const empty = document.getElementById('stickersEmpty');
            
            loading.style.display = 'flex';
            content.style.display = 'none';
            
            try {
                // sticker_packs ì»¬ë ‰ì…˜ì—ì„œ ë¡œë“œ
                const snapshot = await getDocs(collection(db, 'sticker_packs'));
                
                if (snapshot.empty) {
                    empty.style.display = 'block';
                    grid.innerHTML = '';
                } else {
                    empty.style.display = 'none';
                    grid.innerHTML = '';
                    
                    // íŒ©ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ìƒì„±ì¼ ê¸°ì¤€ ì •ë ¬
                    const packs = [];
                    snapshot.forEach(doc => {
                        packs.push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                    
                    // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬ (ìµœì‹  ìˆœ)
                    packs.sort((a, b) => {
                        const aTime = a.data.created_at?.toMillis?.() || 0;
                        const bTime = b.data.created_at?.toMillis?.() || 0;
                        return bTime - aTime;
                    });
                    
                    // ê° ìŠ¤í‹°ì»¤íŒ©ì˜ ê°œë³„ ìŠ¤í‹°ì»¤ë“¤ì„ ì¹´ë“œë¡œ í‘œì‹œ
                    packs.forEach(packItem => {
                        const pack = packItem.data;
                        const stickers = pack.stickers || [];
                        
                        // ìŠ¤í‹°ì»¤íŒ© í—¤ë”
                        const packHeader = document.createElement('div');
                        packHeader.style.cssText = 'grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;';
                        packHeader.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0 0 5px 0; font-size: 18px;">${pack.pack_name || 'ì´ë¦„ ì—†ìŒ'}</h3>
                                    <p style="margin: 0; font-size: 13px; opacity: 0.9;">ID: ${pack.pack_id || 'N/A'} | ìŠ¤í‹°ì»¤ ${pack.sticker_count || 0}ê°œ</p>
                                </div>
                                <button onclick="deleteStickerPack('${packItem.id}')" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    ğŸ—‘ï¸ íŒ© ì‚­ì œ
                                </button>
                            </div>
                        `;
                        grid.appendChild(packHeader);
                        
                        // ìŠ¤í‹°ì»¤ ì¶”ê°€ ë²„íŠ¼ ì¹´ë“œ
                        const addCard = document.createElement('div');
                        addCard.style.cssText = 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; min-height: 200px; cursor: pointer; transition: transform 0.2s;';
                        addCard.onmouseover = () => addCard.style.transform = 'scale(1.05)';
                        addCard.onmouseout = () => addCard.style.transform = 'scale(1)';
                        addCard.onclick = () => showAddStickerDialog(packItem.id, pack.pack_name);
                        addCard.innerHTML = `
                            <div style="text-align: center; color: white;">
                                <div style="font-size: 48px; margin-bottom: 10px;">â•</div>
                                <div style="font-size: 16px; font-weight: 600;">ìŠ¤í‹°ì»¤ ì¶”ê°€</div>
                            </div>
                        `;
                        grid.appendChild(addCard);
                        
                        // ê° ìŠ¤í‹°ì»¤ ì¹´ë“œ
                        stickers.forEach((sticker, index) => {
                            const card = createStickerPackItemCard(packItem.id, pack.pack_id, sticker, index);
                            grid.appendChild(card);
                        });
                    });
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (error) {
                console.error('Error loading stickers:', error);
                alert('ìŠ¤í‹°ì»¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                loading.style.display = 'none';
            }
        };

        // ìŠ¤í‹°ì»¤íŒ© ì•„ì´í…œ ì¹´ë“œ ìƒì„±
        function createStickerPackItemCard(packDocId, packId, sticker, index) {
            const card = document.createElement('div');
            card.style.cssText = 'background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; position: relative;';
            
            card.innerHTML = `
                <button onclick="deleteSingleSticker('${packDocId}', ${index}, '${sticker.sticker_name}')" 
                        style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                        title="ìŠ¤í‹°ì»¤ ì‚­ì œ">
                    âŒ
                </button>
                <img src="${sticker.image_url}" style="width: 100%; height: 150px; object-fit: contain; border-radius: 8px; margin-bottom: 10px; background: #f3f4f6;">
                <h4 style="margin: 10px 0 5px 0; font-size: 14px; color: #111827;">${sticker.sticker_name || 'ìŠ¤í‹°ì»¤'}</h4>
                <p style="color: #6b7280; font-size: 11px; margin: 5px 0;">ID: ${sticker.sticker_id || 'N/A'}</p>
                <p style="color: #9ca3af; font-size: 10px; margin: 5px 0;">ìˆœì„œ: ${sticker.order + 1}</p>
            `;
            
            return card;
        }

        // ìŠ¤í‹°ì»¤íŒ© ì‚­ì œ
        window.deleteStickerPack = async (packDocId) => {
            if (!confirm('ì •ë§ ì´ ìŠ¤í‹°ì»¤íŒ©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
            
            try {
                await deleteDoc(doc(db, 'sticker_packs', packDocId));
                alert('ìŠ¤í‹°ì»¤íŒ©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadStickers();
            } catch (error) {
                console.error('Error deleting sticker pack:', error);
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ê°œë³„ ìŠ¤í‹°ì»¤ ì‚­ì œ
        window.deleteSingleSticker = async (packDocId, stickerIndex, stickerName) => {
            if (!confirm(`"${stickerName}" ìŠ¤í‹°ì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;
            
            try {
                // Firestoreì—ì„œ íŒ© ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
                const packRef = doc(db, 'sticker_packs', packDocId);
                const packDoc = await getDoc(packRef);
                
                if (!packDoc.exists()) {
                    alert('ìŠ¤í‹°ì»¤íŒ©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const packData = packDoc.data();
                const stickers = packData.stickers || [];
                
                // í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ìŠ¤í‹°ì»¤ ì œê±°
                const deletedSticker = stickers[stickerIndex];
                stickers.splice(stickerIndex, 1);
                
                // Storageì—ì„œ ì´ë¯¸ì§€ ì‚­ì œ ì‹œë„
                try {
                    if (deletedSticker.file_name) {
                        const storageRef = ref(storage, `stickers/${packData.pack_id}/${deletedSticker.file_name}`);
                        await deleteObject(storageRef);
                    }
                } catch (storageError) {
                    console.warn('Storage ì‚­ì œ ì‹¤íŒ¨ (ì´ë¯¸ ì‚­ì œë¨):', storageError);
                }
                
                // ìˆœì„œ ì¬ì •ë ¬
                stickers.forEach((s, i) => {
                    s.order = i;
                });
                
                // Firestore ì—…ë°ì´íŠ¸
                await updateDoc(packRef, {
                    stickers: stickers,
                    sticker_count: stickers.length
                });
                
                alert('ìŠ¤í‹°ì»¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadStickers();
            } catch (error) {
                console.error('Error deleting sticker:', error);
                alert('ìŠ¤í‹°ì»¤ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ìŠ¤í‹°ì»¤ ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        window.showAddStickerDialog = (packDocId, packName) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/gif,image/webp';
            input.multiple = true;
            
            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                if (!confirm(`${packName}ì— ${files.length}ê°œì˜ ìŠ¤í‹°ì»¤ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                
                try {
                    // Firestoreì—ì„œ íŒ© ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
                    const packRef = doc(db, 'sticker_packs', packDocId);
                    const packDoc = await getDoc(packRef);
                    
                    if (!packDoc.exists()) {
                        alert('ìŠ¤í‹°ì»¤íŒ©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }
                    
                    const packData = packDoc.data();
                    const stickers = packData.stickers || [];
                    const startIndex = stickers.length;
                    
                    // í”„ë¡œê·¸ë ˆìŠ¤ í‘œì‹œ
                    const progressDiv = document.createElement('div');
                    progressDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; min-width: 300px;';
                    progressDiv.innerHTML = `
                        <h3 style="margin: 0 0 15px 0; text-align: center;">ìŠ¤í‹°ì»¤ ì—…ë¡œë“œ ì¤‘...</h3>
                        <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden;">
                            <div id="addStickerProgressBar" style="background: linear-gradient(90deg, #10b981 0%, #059669 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="addStickerProgressText" style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">0 / ${files.length}</p>
                    `;
                    document.body.appendChild(progressDiv);
                    
                    const progressBar = document.getElementById('addStickerProgressBar');
                    const progressText = document.getElementById('addStickerProgressText');
                    
                    // ê° íŒŒì¼ ì—…ë¡œë“œ
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const newIndex = startIndex + i;
                        
                        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                        const progress = ((i / files.length) * 100).toFixed(0);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${i + 1} / ${files.length}`;
                        
                        // Firebase Storageì— ì—…ë¡œë“œ
                        const fileName = `sticker_${String(newIndex + 1).padStart(3, '0')}.${file.name.split('.').pop()}`;
                        const storagePath = `stickers/${packData.pack_id}/${fileName}`;
                        const storageRef = ref(storage, storagePath);
                        
                        const uploadTask = await uploadBytesResumable(storageRef, file);
                        const downloadURL = await getDownloadURL(uploadTask.ref);
                        
                        stickers.push({
                            sticker_id: `${packData.pack_id}_${newIndex}`,
                            sticker_name: file.name.replace(/\.(gif|png|webp)$/i, ''),
                            image_url: downloadURL,
                            order: newIndex,
                            file_name: fileName
                        });
                    }
                    
                    // Firestore ì—…ë°ì´íŠ¸
                    await updateDoc(packRef, {
                        stickers: stickers,
                        sticker_count: stickers.length
                    });
                    
                    progressBar.style.width = '100%';
                    progressText.textContent = 'âœ… ì™„ë£Œ!';
                    
                    setTimeout(() => {
                        document.body.removeChild(progressDiv);
                        alert(`${files.length}ê°œì˜ ìŠ¤í‹°ì»¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        loadStickers();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error adding stickers:', error);
                    alert('ìŠ¤í‹°ì»¤ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
                    // í”„ë¡œê·¸ë ˆìŠ¤ ë‹¤ì´ì–¼ë¡œê·¸ ì œê±°
                    const progressDiv = document.body.querySelector('div[style*="position: fixed"]');
                    if (progressDiv) document.body.removeChild(progressDiv);
                }
            };
            
            input.click();
        };

        // ìŠ¤í‹°ì»¤ ëª¨ë‹¬ ë‹«ê¸°
        window.closeStickerModal = () => {
            document.getElementById('stickerEditModal').classList.remove('show');
            window.currentSticker = null;
        };

        // ======================
        // ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ======================

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        window.loadUsers = async () => {
            const loading = document.getElementById('usersLoading');
            const content = document.getElementById('usersContent');
            const tbody = document.getElementById('usersBody');
            const empty = document.getElementById('usersEmpty');
            
            loading.style.display = 'flex';
            content.style.display = 'none';
            
            try {
                // ì¸ë±ìŠ¤ ë¶ˆí•„ìš”í•˜ë„ë¡ ë‹¨ìˆœ ì¿¼ë¦¬ ì‚¬ìš©
                const snapshot = await getDocs(
                    query(collection(db, 'users'), limit(100))
                );
                
                if (snapshot.empty) {
                    empty.style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    empty.style.display = 'none';
                    tbody.innerHTML = '';
                    
                    // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ì •ë ¬
                    const users = [];
                    snapshot.forEach(doc => {
                        users.push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                    
                    // ê°€ì…ì¼ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹  ìˆœ)
                    users.sort((a, b) => {
                        const aDate = a.data.registeredAt?.toDate?.() || new Date(a.data.registeredAt || 0);
                        const bDate = b.data.registeredAt?.toDate?.() || new Date(b.data.registeredAt || 0);
                        return bDate - aDate;
                    });
                    
                    users.forEach(user => {
                        const row = createUserRow(user.id, user.data);
                        tbody.appendChild(row);
                    });
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (error) {
                console.error('Error loading users:', error);
                alert('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                loading.style.display = 'none';
            }
        };

        // ì‚¬ìš©ì ê²€ìƒ‰
        window.searchUsers = async () => {
            const searchQuery = document.getElementById('userSearchQuery').value.trim().toLowerCase();
            
            if (!searchQuery) {
                loadUsers();
                return;
            }
            
            const loading = document.getElementById('usersLoading');
            const content = document.getElementById('usersContent');
            const tbody = document.getElementById('usersBody');
            const empty = document.getElementById('usersEmpty');
            
            loading.style.display = 'flex';
            content.style.display = 'none';
            
            try {
                // FirestoreëŠ” ë¶€ë¶„ ê²€ìƒ‰ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ëª¨ë“  ì‚¬ìš©ìë¥¼ ê°€ì ¸ì™€ì„œ í•„í„°ë§
                const q = query(collection(db, 'users'), limit(500));
                const snapshot = await getDocs(q);
                
                const results = [];
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const nickname = (user.nickname || '').toLowerCase();
                    const userId = doc.id.toLowerCase();
                    
                    if (nickname.includes(searchQuery) || userId.includes(searchQuery)) {
                        results.push({ id: doc.id, data: user });
                    }
                });
                
                if (results.length === 0) {
                    empty.style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    empty.style.display = 'none';
                    tbody.innerHTML = '';
                    
                    results.forEach(result => {
                        const tr = createUserRow(result.id, result.data);
                        tbody.appendChild(tr);
                    });
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (error) {
                console.error('Error searching users:', error);
                alert('ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨: ' + error.message);
                loading.style.display = 'none';
            }
        };

        // ì‚¬ìš©ì í–‰ ìƒì„±
        function createUserRow(userId, user) {
            const tr = document.createElement('tr');
            
            const registeredDate = user.registeredAt?.toDate?.() || new Date(user.registeredAt);
            
            // ë‚ ì§œì™€ ì‹œê°„ í¬ë§· (ì˜ˆ: 2026. 2. 13. ì˜¤í›„ 3:45)
            const dateStr = registeredDate.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            const profileImg = user.profilePhoto || 'https://via.placeholder.com/40';
            const qkeyBalance = user.qkeyBalance || 0;
            const isBanned = user.banned === true;
            
            // ìƒíƒœ í‘œì‹œ
            const statusHTML = isBanned 
                ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; background: #ef444420; color: #ef4444;">ğŸš« ì°¨ë‹¨ë¨</span>'
                : '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; background: #10b98120; color: #10b981;">âœ… ì •ìƒ</span>';
            
            // ì°¨ë‹¨ ë²„íŠ¼ (ë‹¨ìƒ‰ ìŠ¤íƒ€ì¼)
            const banButtonHTML = isBanned
                ? `<button onclick="unbanUser('${userId}')" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 5px;">ğŸ”“ ì°¨ë‹¨í•´ì œ</button>`
                : `<button onclick="banUser('${userId}', '${(user.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ').replace(/'/g, "\\'")}')" style="padding: 6px 12px; background: #4b5563; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 5px;">ğŸš« ì°¨ë‹¨</button>`;
            
            tr.innerHTML = `
                <td>
                    <img src="${profileImg}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                </td>
                <td><strong>${user.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong><br><code style="font-size: 11px;">${userId.substring(0, 12)}...</code></td>
                <td>${dateStr}</td>
                <td><strong style="color: #667eea;">${qkeyBalance.toLocaleString()} QKEY</strong></td>
                <td>
                    ${statusHTML}
                </td>
                <td>
                    ${banButtonHTML}
                    <button onclick="viewUserDetail('${userId}')" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 5px;">
                        ğŸ‘ï¸ ìƒì„¸
                    </button>
                    <button onclick="adjustQkey('${userId}')" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                        ğŸ’° QKEY
                    </button>
                </td>
            `;
            
            return tr;
        }

        // ì‚¬ìš©ì ìƒì„¸ ë³´ê¸°
        window.viewUserDetail = async (userId) => {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                
                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const user = userDoc.data();
                window.currentUserDetail = { id: userId, ...user };
                
                // QKEY ê±°ë˜ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
                const transactionsQuery = query(
                    collection(db, 'qkey_transactions'),
                    where('userId', '==', userId),
                    limit(100)
                );
                const transactionsSnap = await getDocs(transactionsQuery);
                
                const transactions = [];
                transactionsSnap.forEach(doc => {
                    transactions.push(doc.data());
                });
                
                // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬ (ìµœì‹  ìˆœ) í›„ 10ê°œë§Œ ì„ íƒ
                transactions.sort((a, b) => {
                    const aTime = a.timestamp?.toMillis?.() || 0;
                    const bTime = b.timestamp?.toMillis?.() || 0;
                    return bTime - aTime;
                });
                const recentTransactions = transactions.slice(0, 10);
                
                let transactionsHtml = '<p style="color: #6b7280;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                if (recentTransactions.length > 0) {
                    transactionsHtml = '<div style="max-height: 200px; overflow-y: auto;">';
                    recentTransactions.forEach(tx => {
                        const date = tx.timestamp?.toDate?.().toLocaleDateString('ko-KR') || '';
                        const amountColor = tx.amount > 0 ? '#10b981' : '#ef4444';
                        const amountSign = tx.amount > 0 ? '+' : '';
                        transactionsHtml += `
                            <div style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">
                                <strong style="color: ${amountColor};">${amountSign}${tx.amount} QKEY</strong>
                                <span style="color: #6b7280; margin-left: 10px;">${tx.type || 'ê±°ë˜'}</span>
                                <span style="color: #9ca3af; float: right;">${date}</span>
                            </div>
                        `;
                    });
                    transactionsHtml += '</div>';
                }
                
                const registeredDate = user.registeredAt?.toDate?.() || new Date(user.registeredAt);
                const registeredDateTimeStr = registeredDate.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                
                document.getElementById('userDetailBody').innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${user.profilePhoto || 'https://via.placeholder.com/100'}" 
                             style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
                        <h3 style="margin: 10px 0 5px 0;">${user.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}</h3>
                        <code style="color: #6b7280; font-size: 12px;">${userId}</code>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">QKEY ì”ì•¡</p>
                                <p style="font-size: 20px; font-weight: 600; color: #667eea;">${(user.qkeyBalance || 0).toLocaleString()} QKEY</p>
                            </div>
                            <div>
                                <p style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">ê°€ì…ì¼</p>
                                <p style="font-size: 14px; font-weight: 600;">${registeredDateTimeStr}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="font-weight: 600; margin-bottom: 8px;">ğŸ“ ì—°ë½ì²˜</p>
                        <p style="color: #6b7280; font-size: 14px;">${user.phone || 'ì •ë³´ ì—†ìŒ'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="font-weight: 600; margin-bottom: 8px;">ğŸ”— QR URL</p>
                        <code style="font-size: 12px; color: #667eea; word-break: break-all;">${user.qrUrl || 'ì •ë³´ ì—†ìŒ'}</code>
                    </div>
                    
                    <div>
                        <p style="font-weight: 600; margin-bottom: 8px;">ğŸ’° ìµœê·¼ ê±°ë˜ ë‚´ì—­</p>
                        ${transactionsHtml}
                    </div>
                `;
                
                document.getElementById('userDetailModal').classList.add('show');
            } catch (error) {
                console.error('Error loading user detail:', error);
                alert('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ì‚¬ìš©ì ëª¨ë‹¬ ë‹«ê¸°
        window.closeUserModal = () => {
            document.getElementById('userDetailModal').classList.remove('show');
            window.currentUserDetail = null;
        };

        // QKEY ì¡°ì • ëª¨ë‹¬ ì—´ê¸°
        window.adjustQkey = async (userId) => {
            window.currentUserDetail = { id: userId };
            document.getElementById('qkeyAdjustType').value = 'add';
            document.getElementById('qkeyAdjustAmount').value = '100';
            document.getElementById('qkeyAdjustReason').value = '';
            document.getElementById('qkeyAdjustModal').classList.add('show');
        };

        // QKEY ì¡°ì • ëª¨ë‹¬ ë‹«ê¸°
        window.closeQkeyAdjustModal = () => {
            document.getElementById('qkeyAdjustModal').classList.remove('show');
            window.currentUserDetail = null;
        };

        // QKEY ì¡°ì • ì ìš©
        window.applyQkeyAdjustment = async () => {
            if (!window.currentUserDetail) return;
            
            const userId = window.currentUserDetail.id;
            const type = document.getElementById('qkeyAdjustType').value;
            const amount = parseInt(document.getElementById('qkeyAdjustAmount').value);
            const reason = document.getElementById('qkeyAdjustReason').value;
            
            if (!amount || amount <= 0) {
                alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!reason.trim()) {
                alert('ì¡°ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            try {
                // ì‚¬ìš©ì í˜„ì¬ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const currentBalance = userDoc.data().qkeyBalance || 0;
                const adjustAmount = type === 'add' ? amount : -amount;
                const newBalance = currentBalance + adjustAmount;
                
                if (newBalance < 0) {
                    alert('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');
                    return;
                }
                
                // ì‚¬ìš©ì ì”ì•¡ ì—…ë°ì´íŠ¸
                await updateDoc(doc(db, 'users', userId), {
                    qkeyBalance: newBalance
                });
                
                // ê±°ë˜ ë‚´ì—­ ì¶”ê°€
                await addDoc(collection(db, 'qkey_transactions'), {
                    userId: userId,
                    amount: adjustAmount,
                    type: type === 'add' ? 'admin_grant' : 'admin_deduct',
                    reason: reason,
                    timestamp: Timestamp.now(),
                    adminEmail: window.currentUser.email
                });
                
                alert(`QKEY ${type === 'add' ? 'ì§€ê¸‰' : 'ì°¨ê°'}ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤`);
                closeQkeyAdjustModal();
                loadUsers();
            } catch (error) {
                console.error('Error adjusting QKEY:', error);
                alert('QKEY ì¡°ì • ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ì‚¬ìš©ì ì°¨ë‹¨
        window.banUser = async (userId, nickname) => {
            if (!confirm(`âš ï¸ ì‚¬ìš©ì ì°¨ë‹¨\n\nì‚¬ìš©ì: ${nickname}\n\nì´ ì‚¬ìš©ìë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì°¨ë‹¨ëœ ì‚¬ìš©ìëŠ”:\nâ€¢ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\nâ€¢ ë™ì¼í•œ QR ì£¼ì†Œë¡œ ì¬ê°€ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\nâ€¢ ì°¨ë‹¨ í•´ì œ ì „ê¹Œì§€ ëª¨ë“  ì„œë¹„ìŠ¤ ì´ìš©ì´ ë¶ˆê°€í•©ë‹ˆë‹¤`)) {
                return;
            }
            
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const userData = userDoc.data();
                const qrCodeUrl = userData.qrCodeUrl || userData.qrUrl || '';
                
                // ì‚¬ìš©ì ë¬¸ì„œ ì—…ë°ì´íŠ¸
                await updateDoc(doc(db, 'users', userId), {
                    banned: true,
                    bannedAt: Timestamp.now(),
                    bannedBy: window.currentUser.email,
                    bannedQrCode: qrCodeUrl
                });
                
                // ì°¨ë‹¨ ë¡œê·¸ ê¸°ë¡
                await addDoc(collection(db, 'ban_logs'), {
                    userId: userId,
                    nickname: nickname,
                    qrCodeUrl: qrCodeUrl,
                    action: 'ban',
                    timestamp: Timestamp.now(),
                    adminEmail: window.currentUser.email
                });
                
                alert(`âœ… ${nickname} ì‚¬ìš©ìê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤`);
                loadUsers();
            } catch (error) {
                console.error('Error banning user:', error);
                alert('ì‚¬ìš©ì ì°¨ë‹¨ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ì‚¬ìš©ì ì°¨ë‹¨ í•´ì œ
        window.unbanUser = async (userId) => {
            if (!confirm('ì´ ì‚¬ìš©ìì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const userData = userDoc.data();
                
                // ì‚¬ìš©ì ë¬¸ì„œ ì—…ë°ì´íŠ¸
                await updateDoc(doc(db, 'users', userId), {
                    banned: false,
                    unbannedAt: Timestamp.now(),
                    unbannedBy: window.currentUser.email
                });
                
                // ì°¨ë‹¨ í•´ì œ ë¡œê·¸ ê¸°ë¡
                await addDoc(collection(db, 'ban_logs'), {
                    userId: userId,
                    nickname: userData.nickname,
                    action: 'unban',
                    timestamp: Timestamp.now(),
                    adminEmail: window.currentUser.email
                });
                
                alert(`âœ… ${userData.nickname} ì‚¬ìš©ìì˜ ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
                loadUsers();
            } catch (error) {
                console.error('Error unbanning user:', error);
                alert('ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ì¤‘ë³µ ë‹‰ë„¤ì„ ì œê±°
        window.removeDuplicateNicknames = async () => {
            if (!confirm('âš ï¸ ê²½ê³ !\n\në™ì¼í•œ ë‹‰ë„¤ì„ì„ ê°€ì§„ ì‚¬ìš©ì ì¤‘ ê°€ì¥ ìµœê·¼ì— ê°€ì…í•œ ì‚¬ìš©ìë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            if (!confirm('ì •ë§ë¡œ ì¤‘ë³µ ë‹‰ë„¤ì„ì„ ê°€ì§„ ê³„ì •ë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤!')) {
                return;
            }
            
            try {
                // ëª¨ë“  ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
                const usersSnapshot = await getDocs(collection(db, 'users'));
                
                // ë‹‰ë„¤ì„ë³„ë¡œ ê·¸ë£¹í™”
                const nicknameMap = {};
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const nickname = user.nickname;
                    
                    if (nickname) {
                        if (!nicknameMap[nickname]) {
                            nicknameMap[nickname] = [];
                        }
                        
                        nicknameMap[nickname].push({
                            id: doc.id,
                            registeredAt: user.registeredAt?.toDate?.() || new Date(user.registeredAt),
                            data: user
                        });
                    }
                });
                
                // ì¤‘ë³µëœ ë‹‰ë„¤ì„ ì°¾ê¸°
                let totalDuplicates = 0;
                let deletedCount = 0;
                const duplicateNicknames = [];
                
                for (const nickname in nicknameMap) {
                    const users = nicknameMap[nickname];
                    
                    if (users.length > 1) {
                        totalDuplicates += users.length;
                        
                        // ê°€ì…ì¼ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹ ì´ ë¨¼ì €)
                        users.sort((a, b) => b.registeredAt - a.registeredAt);
                        
                        // ê°€ì¥ ìµœê·¼ ê°€ì…ìëŠ” ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
                        const toDelete = users.slice(1);
                        
                        for (const user of toDelete) {
                            await deleteDoc(doc(db, 'users', user.id));
                            deletedCount++;
                        }
                        
                        duplicateNicknames.push({
                            nickname: nickname,
                            total: users.length,
                            deleted: toDelete.length
                        });
                    }
                }
                
                if (deletedCount === 0) {
                    alert('ì¤‘ë³µëœ ë‹‰ë„¤ì„ì´ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    let message = `âœ… ì¤‘ë³µ ë‹‰ë„¤ì„ ì œê±° ì™„ë£Œ!\n\n`;
                    message += `ğŸ“Š ì‚­ì œëœ ê³„ì •: ${deletedCount}ê°œ\n`;
                    message += `ğŸ‘¤ ì˜í–¥ë°›ì€ ë‹‰ë„¤ì„: ${duplicateNicknames.length}ê°œ\n\n`;
                    
                    duplicateNicknames.forEach(item => {
                        message += `- "${item.nickname}": ${item.total}ê°œ ì¤‘ ${item.deleted}ê°œ ì‚­ì œ\n`;
                    });
                    
                    alert(message);
                    loadUsers();
                }
            } catch (error) {
                console.error('Error removing duplicate nicknames:', error);
                alert('ì¤‘ë³µ ë‹‰ë„¤ì„ ì œê±° ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = (event) => {
            const modal = document.getElementById('withdrawModal');
            if (event.target === modal) {
                closeModal();
            }
            
            const stickerModal = document.getElementById('stickerEditModal');
            if (event.target === stickerModal) {
                closeStickerModal();
            }
            
            const userModal = document.getElementById('userDetailModal');
            if (event.target === userModal) {
                closeUserModal();
            }
            
            const qkeyModal = document.getElementById('qkeyAdjustModal');
            if (event.target === qkeyModal) {
                closeQkeyAdjustModal();
            }
        };
    </script>
</body>
</html>
